#!/bin/bash

# Git hook to auto-publish to npm on push
# To install: ln -sf ../../.githooks/pre-push .git/hooks/pre-push

set -e

echo "ğŸš€ Pre-push hook: Building and publishing..."

# Check if we're on main branch
current_branch=$(git branch --show-current)
if [ "$current_branch" != "main" ]; then
    echo "â„¹ï¸  Not on main branch, skipping publish"
    exit 0
fi

# Check if NPM_TOKEN is set
if [ -z "$NPM_TOKEN" ]; then
    echo "âš ï¸  NPM_TOKEN not set, skipping publish"
    echo "   Set with: export NPM_TOKEN=your_token"
    exit 0
fi

# Build the project
echo "ğŸ”¨ Building..."
bun run build || {
    echo "âŒ Build failed, but continuing (existing TS errors)"
}

# Version bump (patch by default)
echo "ğŸ“¦ Bumping version..."
npm version patch

# Publish to npm
echo "ğŸ“¤ Publishing to npm..."
npm publish --access public

echo "âœ… Published successfully!"