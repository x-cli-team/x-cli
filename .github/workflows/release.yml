# ðŸš¨ CRITICAL WARNING: AUTOMATED RELEASE WORKFLOW
#
# This workflow handles automated NPM publishing and version management.
# It took multiple iterations to get working correctly.
#
# DO NOT MODIFY without understanding the full dependency chain:
# - GitHub Secrets: PAT_TOKEN, NPM_TOKEN (required)
# - Package name: "@xagent/one-shot"
# - Git hooks: .husky/pre-commit + scripts/check-version.cjs
# - NPM authentication: Direct .npmrc creation (not npm config)
# - Dependency management: Clean install to avoid Rollup cache issues
#
# If this breaks, see troubleshooting docs:
# - .agent/sop/npm-publishing-troubleshooting.md
# - .agent/incidents/incident-npm-publish-failure.md
# - .agent/sop/release-management.md
#
# Last working config verified: 2025-10-17
# Working example: Successfully publishes version 1.0.87+
#
# âš ï¸ TEST ALL CHANGES IN A FORK FIRST!

name: Release
on:
  push:
    branches: [main]

permissions:
  contents: write
  packages: write
  id-token: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install

      - name: Link CLI for testing
        run: npm link

      - name: Set test API key for validation
        run: echo "X_API_KEY=test-key-for-validation-only" >> $GITHUB_ENV

      # Prevent loops if last commit was an automated bump, but allow GitHub releases for release PR merges
      - name: Check if should release
        id: should-release
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -qiE "^Bump version to "; then
            echo "should_release=publish_only" >> $GITHUB_OUTPUT
            echo "Version bump detected; publishing existing version."
          elif echo "$COMMIT_MSG" | grep -qi "Merge pull request.*release/"; then
            echo "should_release=github_release_only" >> $GITHUB_OUTPUT
            echo "Release PR merge detected; creating GitHub release only."
          elif echo "$COMMIT_MSG" | grep -qi "Merge pull request"; then
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "Non-release merge commit detected; skipping release."
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "Proceeding with full release."
          fi

      - name: Bump patch version (no tag yet)
        if: steps.should-release.outputs.should_release == 'true'
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          NEW_VER=$(npm version patch --no-git-tag-version)

          # Update README version to match package.json
          if [ -f README.md ]; then
            NEW_VER_NUMBER=${NEW_VER#v}
            sed -i "s/^## [0-9]\+\.[0-9]\+\.[0-9]\+/## ${NEW_VER_NUMBER}/g" README.md
            echo "Updated README.md to version ${NEW_VER_NUMBER}"
          fi

          git add package.json package-lock.json README.md || true
          git commit -m "Bump version to ${NEW_VER#v}"

      - name: Create release branch and PR
        if: steps.should-release.outputs.should_release == 'true'
        run: |
          NEW_VER=$(node -p "require('./package.json').version")
          RELEASE_BRANCH="release/v${NEW_VER}-$(date +%s)"
          echo "NEW_VER=${NEW_VER}" >> $GITHUB_ENV
          echo "RELEASE_BRANCH=${RELEASE_BRANCH}" >> $GITHUB_ENV

          git checkout -b $RELEASE_BRANCH
          git push origin $RELEASE_BRANCH

          # Create PR
          gh pr create --title "Release v${NEW_VER}" --body "Automated release bump to v${NEW_VER}" --base main --head $RELEASE_BRANCH

          # Get PR number and merge using admin privileges (bypass allows this)
          PR_NUMBER=$(gh pr list --head $RELEASE_BRANCH --json number --jq '.[0].number')
          gh pr merge $PR_NUMBER --merge --delete-branch --admin
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Create tag and push
        if: steps.should-release.outputs.should_release == 'true'
        run: |
          git tag "v${NEW_VER}"
          git push origin "v${NEW_VER}"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Configure npm auth
        if: steps.should-release.outputs.should_release == 'true' || steps.should-release.outputs.should_release == 'publish_only'
        run: |
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Build
        if: steps.should-release.outputs.should_release == 'true' || steps.should-release.outputs.should_release == 'publish_only'
        run: npm run build

      - name: Dry run (sanity check)
        if: steps.should-release.outputs.should_release == 'true' || steps.should-release.outputs.should_release == 'publish_only'
        run: npm publish --access public --dry-run

      - name: Publish to npm (primary package @xagent/one-shot)
        if: steps.should-release.outputs.should_release == 'true' || steps.should-release.outputs.should_release == 'publish_only'
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm (legacy package @xagent/x-cli)
        if: steps.should-release.outputs.should_release == 'true' || steps.should-release.outputs.should_release == 'publish_only'
        continue-on-error: true # Don't fail workflow if legacy publish fails
        run: |
          echo "ðŸ“¦ Publishing legacy package @xagent/x-cli for backwards compatibility..."

          # Backup current package.json
          cp package.json package.json.primary

          # Use legacy package.json
          cp package-legacy.json package.json

          # Update version to match current version
          NEW_VER=$(node -e "console.log(JSON.parse(require('fs').readFileSync('./package.json.primary', 'utf8')).version)")
          sed -i "s/\"version\": \".*\"/\"version\": \"$NEW_VER\"/" package.json

          # Remove deprecated field to allow publishing
          sed -i '/"deprecated":/d' package.json

          echo "Publishing @xagent/x-cli@$NEW_VER..."
          npm publish --access public

          # Restore primary package.json
          mv package.json.primary package.json

          echo "âœ… Successfully published both packages:"
          echo "  ðŸ“¦ @xagent/one-shot@$NEW_VER (primary)"
          echo "  ðŸ“¦ @xagent/x-cli@$NEW_VER (legacy)"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify NPM publication (primary package required, legacy optional)
        if: steps.should-release.outputs.should_release == 'true' || steps.should-release.outputs.should_release == 'publish_only'
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")

          echo "ðŸ” Verifying publication of packages at version $PACKAGE_VERSION..."
          sleep 10

          # Verify primary package (REQUIRED - fail if this fails)
          echo "ðŸ“¦ Verifying @xagent/one-shot (primary - required)..."
          for i in {1..3}; do
            if npm view "@xagent/one-shot@$PACKAGE_VERSION" version >/dev/null 2>&1; then
              echo "âœ… Successfully verified @xagent/one-shot@$PACKAGE_VERSION on NPM registry"
              break
            else
              echo "â³ Attempt $i: Primary package not yet available, waiting 15 seconds..."
              sleep 15
              if [ $i -eq 3 ]; then
                echo "âŒ Failed to verify primary package publication after 3 attempts"
                exit 1
              fi
            fi
          done

          # Verify legacy package (OPTIONAL - warn if this fails)  
          echo "ðŸ“¦ Verifying @xagent/x-cli (legacy - optional)..."
          if npm view "@xagent/x-cli@$PACKAGE_VERSION" version >/dev/null 2>&1; then
            echo "âœ… Successfully verified @xagent/x-cli@$PACKAGE_VERSION on NPM registry"
            LEGACY_SUCCESS=true
          else
            echo "âš ï¸  Legacy package @xagent/x-cli@$PACKAGE_VERSION not found (this is acceptable)"
            LEGACY_SUCCESS=false
          fi

          echo ""
          echo "ðŸŽ‰ NPM Publication Summary:"
          echo "  ðŸ“¦ @xagent/one-shot@$PACKAGE_VERSION (primary) - âœ… VERIFIED"
          if [ "$LEGACY_SUCCESS" = true ]; then
            echo "  ðŸ“¦ @xagent/x-cli@$PACKAGE_VERSION (legacy) - âœ… VERIFIED"
          else
            echo "  ðŸ“¦ @xagent/x-cli@$PACKAGE_VERSION (legacy) - âš ï¸  NOT PUBLISHED (acceptable)"
          fi
          echo ""
          echo "ðŸ”— Primary Package URL: https://www.npmjs.com/package/@xagent/one-shot/v/$PACKAGE_VERSION"

      # ---------- Publish to GitHub Packages ----------
      - name: Create scoped package.json for GitHub Packages
        if: steps.should-release.outputs.should_release == 'true'
        run: |
          # Create a temporary package.json with scoped name for GitHub Packages
          cp package.json package.json.backup

          # Update package name to be scoped (required for GitHub Packages)
          sed -i 's/"name": "@xagent\/one-shot"/"name": "@x-cli-team\/grok-one-shot"/' package.json

          echo "Created scoped package.json for GitHub Packages:"
          grep '"name":' package.json

      - name: Configure GitHub Packages registry
        if: steps.should-release.outputs.should_release == 'true'
        run: |
          # Configure npm to publish scoped packages to GitHub Packages
          rm -f .npmrc
          echo "@x-cli-team:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}" >> .npmrc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Packages
        if: steps.should-release.outputs.should_release == 'true'
        continue-on-error: true # Don't fail workflow if GitHub Packages publish fails
        run: |
          echo "Publishing scoped package to GitHub Packages..."
          npm publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore original package.json
        if: steps.should-release.outputs.should_release == 'true'
        run: |
          # Restore original package.json to avoid affecting future operations
          mv package.json.backup package.json

      # Get current version for GitHub release (needed for release PR merges and publish_only)
      - name: Get current version
        id: get-version
        if: steps.should-release.outputs.should_release == 'github_release_only' || steps.should-release.outputs.should_release == 'publish_only'
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          echo "NEW_VER=${CURRENT_VERSION}" >> $GITHUB_ENV

      # ---------- Create GitHub Release ----------
      - name: Create GitHub Release
        if: steps.should-release.outputs.should_release == 'true' || steps.should-release.outputs.should_release == 'github_release_only' || steps.should-release.outputs.should_release == 'publish_only'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get-version.outputs.version || env.NEW_VER }}
          name: Release v${{ steps.get-version.outputs.version || env.NEW_VER }}
          body: |
            ## ðŸš€ Grok One Shot v${{ steps.get-version.outputs.version || env.NEW_VER }}

            ### Changes
            Automated release triggered by push to main branch.

            ### Installation
            ```bash
            # Primary package (recommended)
            npm install -g @xagent/one-shot@${{ steps.get-version.outputs.version || env.NEW_VER }}
            # or
            npx @xagent/one-shot@${{ steps.get-version.outputs.version || env.NEW_VER }}

            # Legacy package (for backwards compatibility)
            npm install -g @xagent/x-cli@${{ steps.get-version.outputs.version || env.NEW_VER }}
            # or  
            npx @xagent/x-cli@${{ steps.get-version.outputs.version || env.NEW_VER }}
            ```

            ### What's New
            - See [CHANGELOG.md](https://github.com/x-cli-team/grok-one-shot/blob/main/CHANGELOG.md) for details
            - Full release notes available in commit history
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: steps.should-release.outputs.should_release == 'true' || steps.should-release.outputs.should_release == 'publish_only'
        run: |
          rm -f .npmrc
          echo "Restored original package.json"

      - name: Publish summary
        if: steps.should-release.outputs.should_release == 'true' || steps.should-release.outputs.should_release == 'publish_only'
        run: |
          NEW_VER=$(node -p "require('./package.json').version")
          echo "âœ… Release v${NEW_VER} completed successfully!"
          echo "ðŸ“¦ Primary package: https://www.npmjs.com/package/@xagent/one-shot"
          echo "ðŸ“¦ Legacy package: https://www.npmjs.com/package/@xagent/x-cli (best effort)"
          echo "ðŸ“¦ GitHub Packages: https://github.com/x-cli-team/grok-one-shot/pkgs/npm/grok-one-shot (best effort)"

# Test commit to verify branch protection bypass works
# Final test after bypass setup
# Proceed with PR-based releases
# Test with updated PAT_TOKEN
