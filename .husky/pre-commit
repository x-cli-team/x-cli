#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

# âš ï¸  CRITICAL GIT WORKFLOW WARNING FOR AI AGENTS âš ï¸
# 
# THIS REPO USES AUTOMATED NPM PUBLISHING ON MAIN BRANCH PUSHES
# 
# ğŸš¨ PUSH STRATEGY REQUIREMENTS:
# 1. ONLY push to main branch for releases (triggers NPM publish)
# 2. ALWAYS use feature branches for development work  
# 3. NEVER use 'git push origin main' directly
# 4. ALWAYS use smart-push script: 'npm run smart-push' or './scripts/smart-push.sh'
# 5. ALWAYS merge feature branches to main (don't push commits directly to main)
#
# ğŸ“‹ CORRECT WORKFLOW:
#   git checkout -b feature/my-changes
#   [make changes and commits]
#   git checkout main
#   git merge feature/my-changes  
#   npm run smart-push  # This triggers NPM publish
#
# ğŸ’¡ WHY: Every push to main triggers automated version bump + NPM publish
# ğŸ’¡ Missing pushes to main = No NPM releases = Broken deployment pipeline
# ğŸ’¡ Direct pushes to main = Bypass quality gates and monitoring
#
# ğŸ”§ If you pushed to wrong branch: merge to main and use smart-push
#

# Critical folder protection check
node -e "
const fs = require('fs');
const path = require('path');

const criticalFolders = [
  '.agent',
  '.github',
  'apps/site/docs',
  'src',
  'apps/site/src'
];

const missingFolders = criticalFolders.filter(folder => {
  try {
    return !fs.existsSync(folder) || !fs.statSync(folder).isDirectory();
  } catch (e) {
    return true;
  }
});

if (missingFolders.length > 0) {
  console.error('ğŸš¨ CRITICAL FOLDERS MISSING! Commit blocked to prevent accidental deletion.');
  console.error('Missing folders:', missingFolders.join(', '));
  console.error('If this is intentional, use --no-verify to bypass: git commit --no-verify');
  process.exit(1);
} else {
  console.log('âœ… Critical folders verified');
}
"

# Run lint-staged for code formatting
npx lint-staged --config package.json .agent/**/*.{md,mdx} && npx lint-staged --config package.json -- '*.{ts,js,md,mdx}' --ignore-path .gitignore || true

# Sync .agent docs to public docs
echo "ğŸ“ Checking for .agent documentation updates..."
npm run update-agent-docs-auto 2>/dev/null || echo "ğŸ“ Documentation update skipped (not required)"

# Auto-update roadmap with AI agent (skip in CI)
if [ -z "$CI" ] && [ -z "$GITHUB_ACTIONS" ]; then
  echo "ğŸ—“ï¸ Auto-updating roadmap..."
  if command -v grok &> /dev/null && [ -f "apps/site/docs/roadmap.md" ]; then
    CURRENT_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "unknown")
    if timeout 30 grok -p "Review apps/site/docs/roadmap.md and update current version to ${CURRENT_VERSION}. Check if dates need updating to be realistic for future releases. Make minimal necessary changes only." 2>/dev/null; then
      echo "âœ… Roadmap updated successfully"
    else
      echo "âš ï¸ Roadmap auto-update failed - continuing with commit"
    fi
  else
    echo "âš ï¸ Grok not available - skipping roadmap update"
  fi
else
  echo "â­ï¸ Skipping roadmap update in CI environment"
fi

# Run core features test suite (ensure build exists first)
if ! ./scripts/test-core-features-husky.sh false; then
  echo "âŒ Core features validation failed! Essential functionality is broken."
  echo "ğŸ’¡ Common issues:"
  echo "   - TypeScript compilation errors"
  echo "   - Missing dependencies" 
  echo "   - Build configuration problems"
  echo "   - Core source files missing"
  echo ""
  echo "ğŸ”§ To debug: Run './scripts/test-core-features.sh' for detailed analysis"
  echo "ğŸš« Commit blocked - fix core functionality and try again"
  exit 1
else
  echo "âœ… Core features validated successfully"
fi

# Run quick tool system validation
if ! ./scripts/test-tools-quick.sh true 2>/dev/null; then
  echo "âŒ Tool system validation failed! Tool infrastructure is broken."
  echo "ğŸ’¡ Common issues:"
  echo "   - Tool exports missing"
  echo "   - Tool files deleted or moved"
  echo "   - Tool registration broken"
  echo "   - MCP integration issues"
  echo ""
  echo "ğŸ”§ To debug: Run 'npm run test:tools' for comprehensive tool analysis"
  echo "ğŸš« Commit blocked - fix tool system and try again"
  exit 1
else
  echo "âœ… Tool system validated successfully (25+ tools)"
fi

# Run tool code validation to catch accidental changes
if ! ./scripts/validate-tool-code-husky.sh true 2>/dev/null; then
  echo "âŒ Tool code validation failed! Accidental changes detected in core tools."
  echo "ğŸ’¡ Common issues:"
  echo "   - Tool class definitions missing"
  echo "   - Core methods removed or renamed"
  echo "   - Export statements broken"
  echo "   - Tool files deleted or moved"
  echo ""
  echo "ğŸ”§ To debug: Run 'npm run test:tools:validate' for detailed analysis"
  echo "ğŸš« Commit blocked - review changes to tool files carefully"
  exit 1
else
  echo "âœ… Tool code integrity verified (no accidental changes detected)"
fi

# Validate MDX files for compilation errors
echo "ğŸ” Validating MDX documentation..."
if ! npm run build:site > /dev/null 2>&1; then
  echo "âŒ MDX compilation failed! Please fix MDX syntax errors before committing."
  echo "ğŸ’¡ Common issues:"
  echo "   - Custom component closing tags (</Tip>, </Step>, </Note>) inside list items"
  echo "   - Missing blank lines before closing tags"
  echo "   - Unmatched opening/closing tags"
  echo ""
  echo "ğŸ”§ To debug: Run 'npm run build:site' to see detailed errors"
  echo "ğŸš« Commit blocked - fix MDX errors and try again"
  exit 1
else
  echo "âœ… MDX documentation validated successfully"
fi

# TODO: Add session learnings capture here
# This could log agent interactions, learnings, or changes made during the session
# For now, this is a placeholder for future implementation