#!/usr/bin/env sh

# 🚨 CRITICAL WARNING: DO NOT MODIFY THIS PRE-COMMIT HOOK
# This hook is essential for automated NPM publishing workflow.
# Changes to this file can break the entire release automation.
# 
# If you need to modify:
# 1. Test changes thoroughly in a separate branch
# 2. Understand the impact on .github/workflows/release.yml
# 3. See .agent/sop/release-management.md for details
#
# Dependencies: 
# - scripts/check-version.cjs (version bumping logic)
# - package.json version field (must remain "@xagent/x-cli")
# - GitHub Actions automation
#
# Last working config verified: 2025-10-17

# === SECURITY SCAN ===
echo "🔒 Scanning for exposed secrets and API keys..."

# Check for common secret patterns (OpenAI, GitHub, X.AI tokens)
if git diff --cached --name-only | xargs grep -l -E "(sk-[a-zA-Z0-9]{48}|xai-[a-zA-Z0-9]{48}|[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ghp_[a-zA-Z0-9]{36}|gho_[a-zA-Z0-9]{36}|ghu_[a-zA-Z0-9]{36}|ghr_[a-zA-Z0-9]{36}|ghs_[a-zA-Z0-9]{36})" 2>/dev/null; then
  echo "❌ COMMIT BLOCKED: Potential API keys or secrets detected!"
  echo "🔍 Found patterns that look like real API keys or tokens"
  echo "💡 Please remove sensitive data and use environment variables instead"
  echo "📖 See README.md for secure configuration examples"
  exit 1
fi

# Check for hardcoded sensitive values (assignment patterns)
if git diff --cached --name-only | xargs grep -l -E "(api_key|apiKey|API_KEY|secret|SECRET|password|PASSWORD|token|TOKEN)\s*[:=]\s*['\"][^'\"]{20,}" 2>/dev/null; then
  echo "⚠️  Warning: Potential hardcoded secrets detected"
  echo "🔍 Please verify no real credentials are being committed"
  echo "💡 Use environment variables: GROK_API_KEY, MORPH_API_KEY, etc."
  # Don't exit here - just warn, as this might catch documentation
fi

echo "✅ Security scan passed"

# === VERSION MANAGEMENT ===
node scripts/check-version.cjs
npx lint-staged

# === DEPLOYMENT INSTRUCTIONS FOR AI AGENTS ===
echo ""
echo "📝 Ready to push? Remember to use SMART PUSH to handle automated version bumps:"
echo ""
echo "✅ Use: git pushup"
echo "✅ Use: npm run smart-push"
echo "✅ Use: ./scripts/smart-push.sh"
echo ""
echo "❌ DON'T use: git push origin main (will cause 'fetch first' errors)"
echo ""
echo "💡 See .agent/sop/git-workflow.md for details"
