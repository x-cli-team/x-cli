#!/usr/bin/env sh

# ğŸš¨ CRITICAL WARNING: DO NOT MODIFY THIS PRE-COMMIT HOOK
# This hook is essential for automated NPM publishing workflow.
# Changes to this file can break the entire release automation.
# 
# If you need to modify:
# 1. Test changes thoroughly in a separate branch
# 2. Understand the impact on .github/workflows/release.yml
# 3. See .agent/sop/release-management.md for details
#
# Dependencies: 
# - scripts/check-version.cjs (version bumping logic)
# - package.json version field (must remain "grok-cli-hurry-mode")
# - GitHub Actions automation
#
# Last working config verified: 2025-10-17

# === SECURITY SCAN ===
echo "ğŸ”’ Scanning for exposed secrets and API keys..."

# Check for common secret patterns (OpenAI, GitHub, X.AI tokens)
if git diff --cached --name-only | xargs grep -l -E "(sk-[a-zA-Z0-9]{48}|xai-[a-zA-Z0-9]{48}|[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}|ghp_[a-zA-Z0-9]{36}|gho_[a-zA-Z0-9]{36}|ghu_[a-zA-Z0-9]{36}|ghr_[a-zA-Z0-9]{36}|ghs_[a-zA-Z0-9]{36})" 2>/dev/null; then
  echo "âŒ COMMIT BLOCKED: Potential API keys or secrets detected!"
  echo "ğŸ” Found patterns that look like real API keys or tokens"
  echo "ğŸ’¡ Please remove sensitive data and use environment variables instead"
  echo "ğŸ“– See README.md for secure configuration examples"
  exit 1
fi

# Check for hardcoded sensitive values (assignment patterns)
if git diff --cached --name-only | xargs grep -l -E "(api_key|apiKey|API_KEY|secret|SECRET|password|PASSWORD|token|TOKEN)\s*[:=]\s*['\"][^'\"]{20,}" 2>/dev/null; then
  echo "âš ï¸  Warning: Potential hardcoded secrets detected"
  echo "ğŸ” Please verify no real credentials are being committed"
  echo "ğŸ’¡ Use environment variables: GROK_API_KEY, MORPH_API_KEY, etc."
  # Don't exit here - just warn, as this might catch documentation
fi

echo "âœ… Security scan passed"

# === VERSION MANAGEMENT ===
node scripts/check-version.cjs
npx lint-staged

# === DEPLOYMENT INSTRUCTIONS FOR AI AGENTS ===
echo ""
echo "ğŸ“ Ready to push? Remember to use SMART PUSH to handle automated version bumps:"
echo ""
echo "âœ… Use: git pushup"
echo "âœ… Use: npm run smart-push"
echo "âœ… Use: ./scripts/smart-push.sh"
echo ""
echo "âŒ DON'T use: git push origin main (will cause 'fetch first' errors)"
echo ""
echo "ğŸ’¡ See .agent/sop/git-workflow.md for details"
