#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

# âš ï¸  CRITICAL GIT WORKFLOW WARNING FOR AI AGENTS âš ï¸
# 
# THIS REPO USES AUTOMATED NPM PUBLISHING ON MAIN BRANCH PUSHES
# 
# ðŸš¨ PUSH STRATEGY REQUIREMENTS:
# 1. ONLY push to main branch for releases (triggers NPM publish)
# 2. ALWAYS use feature branches for development work  
# 3. NEVER use 'git push origin main' directly
# 4. ALWAYS use smart-push script: 'npm run smart-push' or './scripts/smart-push.sh'
# 5. ALWAYS merge feature branches to main (don't push commits directly to main)
#
# ðŸ“‹ CORRECT WORKFLOW:
#   git checkout -b feature/my-changes
#   [make changes and commits]
#   git checkout main
#   git merge feature/my-changes  
#   npm run smart-push  # This triggers NPM publish
#
# ðŸ’¡ WHY: Every push to main triggers automated version bump + NPM publish
# ðŸ’¡ Missing pushes to main = No NPM releases = Broken deployment pipeline
# ðŸ’¡ Direct pushes to main = Bypass quality gates and monitoring
#
# ðŸ”§ If you pushed to wrong branch: merge to main and use smart-push
#

# Critical folder protection check
node -e "
const fs = require('fs');
const path = require('path');

const criticalFolders = [
  '.agent',
  '.github',
  'apps/site/docs',
  'src',
  'apps/site/src'
];

const missingFolders = criticalFolders.filter(folder => {
  try {
    return !fs.existsSync(folder) || !fs.statSync(folder).isDirectory();
  } catch (e) {
    return true;
  }
});

if (missingFolders.length > 0) {
  console.error('ðŸš¨ CRITICAL FOLDERS MISSING! Commit blocked to prevent accidental deletion.');
  console.error('Missing folders:', missingFolders.join(', '));
  console.error('If this is intentional, use --no-verify to bypass: git commit --no-verify');
  process.exit(1);
} else {
  console.log('âœ… Critical folders verified');
}
"

# Run lint-staged for code formatting
npx lint-staged || true

# Sync .agent docs to public docs
npm run sync:docs

# TODO: Add session learnings capture here
# This could log agent interactions, learnings, or changes made during the session
# For now, this is a placeholder for future implementation