#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

# âš ï¸  CRITICAL GIT WORKFLOW WARNING FOR AI AGENTS âš ï¸
# 
# THIS REPO USES AUTOMATED NPM PUBLISHING ON MAIN BRANCH PUSHES
# 
# ğŸš¨ PUSH STRATEGY REQUIREMENTS:
# 1. ONLY push to main branch for releases (triggers NPM publish)
# 2. ALWAYS use feature branches for development work  
# 3. NEVER use 'git push origin main' directly
# 4. ALWAYS use smart-push script: 'npm run smart-push' or './scripts/smart-push.sh'
# 5. ALWAYS merge feature branches to main (don't push commits directly to main)
#
# ğŸ“‹ CORRECT WORKFLOW:
#   git checkout -b feature/my-changes
#   [make changes and commits]
#   git checkout main
#   git merge feature/my-changes  
#   npm run smart-push  # This triggers NPM publish
#
# ğŸ’¡ WHY: Every push to main triggers automated version bump + NPM publish
# ğŸ’¡ Missing pushes to main = No NPM releases = Broken deployment pipeline
# ğŸ’¡ Direct pushes to main = Bypass quality gates and monitoring
#
# ğŸ”§ If you pushed to wrong branch: merge to main and use smart-push
#

# Critical folder protection check
node -e "
const fs = require('fs');
const path = require('path');

const criticalFolders = [
  '.agent',
  '.github',
  'apps/site/docs',
  'src',
  'apps/site/src'
];

const missingFolders = criticalFolders.filter(folder => {
  try {
    return !fs.existsSync(folder) || !fs.statSync(folder).isDirectory();
  } catch (e) {
    return true;
  }
});

if (missingFolders.length > 0) {
  console.error('ğŸš¨ CRITICAL FOLDERS MISSING! Commit blocked to prevent accidental deletion.');
  console.error('Missing folders:', missingFolders.join(', '));
  console.error('If this is intentional, use --no-verify to bypass: git commit --no-verify');
  process.exit(1);
} else {
  console.log('âœ… Critical folders verified');
}
"

# Run lint-staged for code formatting
npx lint-staged --config package.json .agent/**/*.{md,mdx} && npx lint-staged --config package.json -- '*.{ts,js,md,mdx}' --ignore-path .gitignore || true

# Sync .agent docs to public docs
echo "ğŸ“ Checking for .agent documentation updates..."
npm run update-agent-docs-auto 2>/dev/null || echo "ğŸ“ Documentation update skipped (not required)"

# Validate MDX files for compilation errors
echo "ğŸ” Validating MDX documentation..."
if ! npm run build:site > /dev/null 2>&1; then
  echo "âŒ MDX compilation failed! Please fix MDX syntax errors before committing."
  echo "ğŸ’¡ Common issues:"
  echo "   - Custom component closing tags (</Tip>, </Step>, </Note>) inside list items"
  echo "   - Missing blank lines before closing tags"
  echo "   - Unmatched opening/closing tags"
  echo ""
  echo "ğŸ”§ To debug: Run 'npm run build:site' to see detailed errors"
  echo "ğŸš« Commit blocked - fix MDX errors and try again"
  exit 1
else
  echo "âœ… MDX documentation validated successfully"
fi

# TODO: Add session learnings capture here
# This could log agent interactions, learnings, or changes made during the session
# For now, this is a placeholder for future implementation